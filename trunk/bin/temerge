#!/bin/bash

# V.2.1-ald

TE_VTP=/var/tmp/portage
TE_DEFMEMSIZE=1750M

#[ "${AE_TMPFS[SIZE]}" ] && TE_MEMSIZE=${AE_TMPFS[SIZE]}
[ "$MEMSIZE" ] && TE_MEMSIZE=$MEMSIZE
[ "$TE_MEMSIZE" ] || TE_MEMSIZE=$TE_DEFMEMSIZE
 
[ "$RC_GOT_FUNCTIONS" ] || . /etc/init.d/functions.sh

 
mounttmpfs() {
	mount -t tmpfs tmpfs -o size=$TE_MEMSIZE $TE_VTP
	mounted="true"
}

unmount() {
	ebegin "unmounting tmpfs"
	umount -f $TE_VTP
	eend $?
}

compile() {
	einfo "emerge ${*}"
	emerge ${*}
	retVal=$?
	return $?
}


# begin
ebegin "Mounting $TE_MEMSIZE of memory to $TE_VTP"

# mount tmp if not mounted
[ "$(mount | grep $TE_VTP)" ] && ewarn "tmpfs already mounted!" || mounttmpfs
eend $?

# do emerge cmd
compile "${*}"

# unmount tmp 
[ "$mounted" ] && unmount

# bye-bye
exit $retVal

